<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Signal Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* --- GRID CONFIGURATION --- */
      /* Defines the 6-column layout: Symbol | Call1 Buy | Call1 Sell | Call2 Buy | Call2 Sell | Symbol */
      .grid-container {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr 2fr;
        font-size: 0.8rem;
      }

      /* --- ANIMATIONS --- */
      /* Standard Highlight (Blue/Green/Red tint) for Call 2 */
      .highlight-signal {
        animation: highlight-fade 15s ease-out forwards;
      }
      @keyframes highlight-fade {
        0% { background-color: rgba(239, 68, 68, 0.4); }
        50% { background-color: rgba(34, 197, 94, 0.4); }
        100% { background-color: transparent; }
      }

      /* Premium Gold Flash for Call 1 */
      .long-term-highlight {
        animation: long-term-flash 1s ease-out 3;
      }
      @keyframes long-term-flash {
        0%, 100% { background-color: transparent; }
        50% { background-color: rgba(234, 179, 8, 0.6); }
      }

      /* Tooltip Visibility */
      .tooltip {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s, visibility 0.2s;
        pointer-events: none;
      }
      .has-tooltip:hover .tooltip {
        visibility: visible;
        opacity: 1;
      }
    </style>
  </head>

  <body class="bg-gray-100 text-gray-900 h-screen flex flex-col">
    <!-- Main Container: Split into 2 Columns (Left/Right) -->
    <main
      id="dashboard-container"
      class="flex-grow overflow-auto p-3 grid grid-cols-1 md:grid-cols-2 gap-3"
    >
      <div id="grid-left" class="bg-white rounded-lg shadow-md overflow-hidden"></div>
      <div id="grid-right" class="bg-white rounded-lg shadow-md overflow-hidden"></div>
    </main>

    <!-- Audio Assets -->
    <audio id="call-1-sound" src="/audio/long-term.mp3" preload="auto"></audio>
    <audio id="call-2-sound" src="/audio/call-2.mp3" preload="auto"></audio>

    <script>
      const gridLeft = document.getElementById("grid-left");
      const gridRight = document.getElementById("grid-right");
      const SIGNAL_KEYS = ["call1_buy", "call1_sell", "call2_buy", "call2_sell"];

      // --- SOUND SYSTEM ---
      let audioUnlocked = false;
      const sounds = {
        call1: new Audio("/audio/long-term.mp3"),
        call2: new Audio("/audio/call-2.mp3")
      };
      
      function playSound(soundId) {
        if (!audioUnlocked) return;
        const sound = sounds[soundId];
        if (sound) {
          sound.currentTime = 0;
          sound.play().catch((error) => console.error(`Error playing ${soundId}:`, error));
        }
      }

      // Unlock audio on first user interaction (browser policy requirement)
      document.body.addEventListener("click", () => {
          if (audioUnlocked) return;
          audioUnlocked = true;
          console.log("Audio unlocked.");
        }, { once: true }
      );

      // --- HELPER: Counter Styling ---
      // Returns CSS classes for the colored circle with the number
      function getCounterClass(count, isBuy) {
        if (!count || count <= 0) return '';
        const baseClasses = "flex items-center justify-center w-4 h-4 rounded-full text-white text-xs font-bold mr-1.5 shadow-sm";
        let colorClass = '';
        if (isBuy) {
          // Green gets darker as count increases
          if (count < 3) colorClass = 'bg-green-500';
          else if (count < 6) colorClass = 'bg-green-600';
          else colorClass = 'bg-green-800';
        } else {
          // Red gets darker as count increases
          if (count < 3) colorClass = 'bg-red-500';
          else if (count < 6) colorClass = 'bg-red-600';
          else colorClass = 'bg-red-800';
        }
        return `${baseClasses} ${colorClass}`;
      }

      // --- RENDER: Table Header ---
      function createHeader() {
        return `
          <div class="grid-container text-xs font-semibold text-center text-gray-500 sticky top-0 bg-white z-10 shadow-sm">
            <!-- Row 1: Main Headers -->
            <div class="p-2 border-b border-r border-gray-200 row-span-2 flex items-center justify-start pl-4 bg-gray-50">Symbol Name</div>
            
            <!-- Call 1: Premium Gold Background -->
            <div class="p-2 border-b border-amber-300 col-span-2 bg-amber-400 text-white font-bold tracking-wider">CALL 1 (PREMIUM)</div>
            
            <!-- Call 2: Standard Gray Background -->
            <div class="p-2 border-b border-r border-gray-200 col-span-2 bg-gray-100 text-gray-600">Call 2</div>
            
            <div class="p-2 border-b border-gray-200 row-span-2 flex items-center justify-end pr-4 bg-gray-50">Symbol Name</div>
            
            <!-- Row 2: Buy/Sell Sub-headers -->
            <div class="p-2 border-b border-amber-200 text-green-700 bg-amber-100">Buy</div>
            <div class="p-2 border-b border-amber-200 text-red-700 bg-amber-100">Sell</div>
            <div class="p-2 border-b border-gray-200 text-green-600 bg-gray-50">Buy</div>
            <div class="p-2 border-b border-r border-gray-200 text-red-600 bg-gray-50">Sell</div>
          </div>
        `;
      }

      // --- RENDER: Main Grid Loop ---
      function renderGrid(container, scriptList, state) {
        let html = createHeader();
        
        scriptList.forEach((symbol, index) => {
          const symbolState = state[symbol];
          // Alternating Row Colors (Stripes)
          const baseRowBg = index % 2 === 0 ? "bg-white" : "bg-gray-50";
          
          let rowHTML = `<div class="grid-container text-center ${baseRowBg}">`;
          
          // 1. Left Symbol Name
          rowHTML += `<div class="p-2 border-b border-r border-gray-200 font-bold text-gray-800 text-sm flex items-center justify-start pl-4">${symbol}</div>`;

          // 2. Loop through 4 signal columns (Call1 Buy, Call1 Sell, Call2 Buy, Call2 Sell)
          SIGNAL_KEYS.forEach((key, cellIndex) => {
            const signalData = symbolState ? symbolState[key] : null;
            const isCall1 = key.startsWith("call1");
            
            // FEATURE: Gold Tint for Call 1 Columns
            let cellBgClass = "";
            let borderColorClass = "border-gray-200"; 

            if (isCall1) {
                cellBgClass = index % 2 === 0 ? "bg-amber-50" : "bg-amber-100/60";
                borderColorClass = "border-amber-200/60";
            }

            // Add right border to Sell columns (index 1 and 3)
            const borderRight = (cellIndex === 1 || cellIndex === 3) ? "border-r" : "";
            let cellClasses = `p-2 border-b ${borderRight} ${borderColorClass} text-xs transition-colors duration-500 h-10 flex items-center justify-center ${cellBgClass}`;

            let cellContent = "";
            if (signalData) {
              const isBuy = key.includes("buy");
              const isActive = signalData.active !== false;
              
              // FEATURE: Strikethrough for inactive signals
              const strikethroughClass = isActive ? '' : 'line-through opacity-50';
              
              // Text Colors (Call 1 is darker/bolder)
              const activeGreen = isCall1 ? 'text-green-700' : 'text-green-600';
              const activeRed = isCall1 ? 'text-red-700' : 'text-red-600';
              const colorClass = isBuy 
                ? (isActive ? activeGreen : 'text-gray-400')
                : (isActive ? activeRed : 'text-gray-400');
              
              const fontClass = isCall1 ? "font-extrabold text-sm" : "font-bold text-sm";
              
              // FEATURE: Tooltip Date & Time Formatting
              // Shows: "Nov 16, 10:30 PM"
              const dateObj = new Date(signalData.time);
              const formattedTime = dateObj.toLocaleString([], { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
              });
              
              // Animation Logic
              const now = Date.now();
              const animationDuration = isCall1 ? 3000 : 15000;
              const isStillNew = signalData.newSince && now - signalData.newSince < animationDuration && isActive;
              const animationClass = isStillNew ? (isCall1 ? "long-term-highlight" : "highlight-signal") : "";
              
              // FEATURE: Counter Logic (Only for Call 1)
              const count = signalData.count || 0;
              // We check 'isCall1' here so Call 2 never shows a counter
              const countDisplay = (count > 0 && isActive && isCall1) 
                ? `<span class="${getCounterClass(count, isBuy)}">${count}</span>` 
                : '';
              
              const tooltipCount = (signalData.count && isCall1) ? ` | Count: <span class="font-bold">${signalData.count}</span>` : '';
              const status = isActive ? '' : ' (Inactive)';

              cellClasses += ` has-tooltip relative ${animationClass}`;
              cellContent = `
                <div class="${colorClass} ${fontClass} flex justify-center items-center">
                  ${countDisplay}
                  <span class="${strikethroughClass}">${signalData.price}</span>
                </div>
                <div class="tooltip absolute bottom-full mb-2 w-max px-3 py-1.5 bg-gray-900 text-white text-xs rounded-md shadow-lg z-20">
                  Time: <span class="font-bold">${formattedTime}</span>${tooltipCount}${status}
                </div>
              `;
            }
            rowHTML += `<div class="${cellClasses}">${cellContent}</div>`;
          });

          // 3. Right Symbol Name
          rowHTML += `<div class="p-2 border-b border-gray-200 font-bold text-gray-800 text-sm flex items-center justify-end pr-4">${symbol}</div>`;

          rowHTML += `</div>`;
          html += rowHTML;
        });
        container.innerHTML = html;
      }

      // --- WEBSOCKET LOGIC ---
      function connectWebSocket() {
        const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const ws = new WebSocket(wsProtocol + window.location.host);

        ws.onopen = () => console.log("Connected.");
        ws.onclose = () => {
          gridLeft.innerHTML = '<p class="text-center text-gray-500 mt-10">Reconnecting...</p>';
          gridRight.innerHTML = "";
          setTimeout(connectWebSocket, 3000);
        };
        ws.onerror = (error) => console.error("WS Error:", error);

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.state && data.scriptListLeft && data.scriptListRight) {
              
              // Check for new signals to play sound
              let newSignalKey = null;
              for (const symbol of [...data.scriptListLeft, ...data.scriptListRight]) {
                if (data.state[symbol]) {
                    for (const key of SIGNAL_KEYS) { 
                        const signalData = data.state[symbol][key];
                        // Condition: Must be new (within 3s) AND Active
                        if (signalData && signalData.newSince && Date.now() - signalData.newSince < 3000 && signalData.active !== false) {
                            newSignalKey = key;
                            break;
                        }
                    }
                }
                if (newSignalKey) break;
              }

              // Play appropriate sound
              if (newSignalKey) {
                if (newSignalKey.startsWith("call1")) playSound("call1");
                else if (newSignalKey.startsWith("call2")) playSound("call2");
              }

              // Update the UI
              renderGrid(gridLeft, data.scriptListLeft, data.state);
              renderGrid(gridRight, data.scriptListRight, data.state);
            }
          } catch (error) { console.error("Error:", error); }
        };
      }

      connectWebSocket();
    </script>
  </body>
</html>